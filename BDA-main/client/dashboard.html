<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chennai Pollution Monitor - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        :root {
            --primary-blue: #3498db;
            --primary-green: #2ecc71;
            --primary-orange: #f39c12;
            --primary-red: #e74c3c;
            --primary-purple: #9b59b6;
            --primary-teal: #1abc9c;
            --text-dark: #2c3e50;
            --text-medium: #546e7a;
            --text-light: #7f8c8d;
            --page-bg: #f8fafc;
            --border-color: #e1e8ed;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--page-bg);
            color: var(--text-dark);
            overflow: hidden;
        }

        .container {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 1500px;
            margin: 0 auto;
            padding: 0 40px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 30px 0 10px;
        }

        .left-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 50px;
            width: auto;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-teal));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
        }

        .header-info {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
            white-space: nowrap;
        }

        .tabs {
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-link {
            display: inline-block;
            text-decoration: none;
            background: none;
            border: none;
            padding: 10px 15px;
            margin-right: 15px;
            font-size: 16px;
            color: var(--text-light);
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            position: relative;
            top: 2px;
        }

        .tab-link.active {
            color: var(--primary-blue);
            font-weight: 700;
            border-bottom: 3px solid var(--primary-blue);
        }

        .dashboard-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1.5fr 3fr;
            gap: 30px;
            padding-bottom: 30px;
            overflow: hidden;
        }

        .left-panel,
        .zone-monitoring,
        .recent-alerts {
            background: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .left-panel {
            padding: 30px;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .aqi-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-light);
        }

        .aqi-value {
            font-size: 100px;
            font-weight: 800;
            margin: 0;
            line-height: 1.1;
        }

        .aqi-status {
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            font-weight: 700;
            margin: 20px 0 30px 0;
            font-size: 16px;
            color: white;
        }

        .pollutant-data {
            margin-top: 20px;
        }

        .pollutant-item {
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
        }

        .pollutant-item:first-child {
            border-top: none;
        }

        .pollutant-item h3 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
        }

        .pollutant-item p {
            margin: 0;
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
        }

        .zone-monitoring {
            padding: 30px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .zone-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }

        .zone-header h2 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            color: var(--text-dark);
        }

        .zone-dropdown select {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: white;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
            -webkit-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="%237f8c8d"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
            cursor: pointer;
            min-width: 150px;
        }

        .t-nagar-detail {
            padding: 20px 0;
            border-bottom: 2px solid var(--border-color);
        }

        .zone-name {
            font-weight: 700;
            font-size: 18px;
            color: var(--text-dark);
        }

        .zone-aqi-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zone-aqi-value {
            font-size: 48px;
            font-weight: 800;
            line-height: 1;
        }

        .zone-aqi-status-small {
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .map-section {
            flex: 1;
            margin-top: 15px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .recent-alerts {
            padding: 20px 30px;
        }

        .alert-bar {
            background: rgba(243, 156, 18, 0.1);
            color: var(--primary-orange);
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
            font-weight: 600;
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .alert-bar strong {
            margin-right: 10px;
            color: var(--text-dark);
            font-weight: 700;
        }

        .footer {
            text-align: center;
            font-size: 12px;
            color: var(--text-light);
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
        }

        .status-color-good { background-color: var(--primary-green); }
        .status-color-moderate { background-color: var(--primary-orange); }
        .status-color-unhealthy-sensitive { background-color: var(--primary-orange); }
        .status-color-unhealthy { background-color: var(--primary-red); }
        .status-color-very-unhealthy { background-color: var(--primary-purple); }
        .status-color-hazardous { background-color: #7e0023; }

        .text-color-good { color: var(--primary-green); }
        .text-color-moderate { color: var(--primary-orange); }
        .text-color-unhealthy-sensitive { color: var(--primary-orange); }
        .text-color-unhealthy { color: var(--primary-red); }
        .text-color-very-unhealthy { color: var(--primary-purple); }
        .text-color-hazardous { color: #7e0023; }

        @media (max-width: 1200px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .container { padding: 0 20px; }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="left-header">
                <img src="./asserts/logo.png" alt="Chennai Pollution Monitor Logo" class="logo">
                <h1>Chennai Pollution Monitor</h1>
            </div>
            <div class="header-info">Last updated: <span id="last-updated">...</span></div>
        </div>

        <div class="tabs">
            <a href="dashboard.html" class="tab-link active">Dashboard</a>
            <a href="graph.html" class="tab-link">Trends</a>
            <a href="alerts.html" class="tab-link">Alerts</a>
        </div>

        <div class="dashboard-grid">
            <div class="left-panel">
                <div class="aqi-title">Overall Air Quality Index (AQI) in Chennai</div>
                <div class="aqi-value" id="overall-aqi">...</div>
                <div class="aqi-status" id="overall-status">Loading...</div>

                <div class="pollutant-data">
                    <div class="pollutant-item">
                        <p>PM2.5 (µg/m³)</p>
                        <h3 id="pm25-value">...</h3>
                    </div>
                    <div class="pollutant-item">
                        <p>CO (ppm)</p>
                        <h3 id="co2-value">...</h3>
                    </div>
                    <div class="pollutant-item">
                        <p>NO₂ (ppb)</p>
                        <h3 id="no2-value">...</h3>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="zone-monitoring">
                    <div class="zone-header">
                        <h2>Zone Monitoring</h2>
                        <div class="zone-dropdown">
                            <select id="zone-select"></select>
                        </div>
                    </div>

                    <div class="t-nagar-detail">
                        <div class="zone-name" id="zone-name-display">Loading...</div>
                        <div class="zone-aqi-display">
                            <span class="zone-aqi-value" id="zone-aqi-value">...</span>
                            <div class="zone-aqi-status-small" id="zone-aqi-status">...</div>
                        </div>
                    </div>

                    <div class="map-section">
                        <div id="map"></div>
                    </div>
                </div>

                <div class="recent-alerts">
                    <div class="alert-bar">
                        <div id="recent-alert-text"><strong>Alert:</strong> Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">Chennai Pollution Monitoring System | Data updates in real-time</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- GLOBAL VARIABLES ---
        let zonesData = []; // Will hold the live data for zones
        const markers = {}; // Declare markers object ONCE, globally.

        // --- DOM ELEMENTS ---
        const overallAQIElement = document.getElementById("overall-aqi");
        const overallStatusElement = document.getElementById("overall-status");
        const zoneSelect = document.getElementById('zone-select');
        const zoneNameDisplay = document.getElementById('zone-name-display');
        const zoneAQIValueElement = document.getElementById('zone-aqi-value');
        const zoneAQIStatusElement = document.getElementById('zone-aqi-status');
        const pm25Value = document.getElementById('pm25-value');
        const co2Value = document.getElementById('co2-value');
        const no2Value = document.getElementById('no2-value');
        const recentAlertText = document.getElementById('recent-alert-text');

        // --- MAP SETUP ---
        const map = L.map('map', { zoomControl: false }).setView([13.0827, 80.2707], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);

        // --- UTILITY FUNCTIONS ---
        function getAQIStatus(aqi) {
            if (aqi <= 50) return { text: "Good", colorClass: "good" };
            if (aqi <= 100) return { text: "Moderate", colorClass: "moderate" };
            if (aqi <= 150) return { text: "Unhealthy for Sensitive Groups", colorClass: "unhealthy-sensitive" };
            if (aqi <= 200) return { text: "Unhealthy", colorClass: "unhealthy" };
            if (aqi <= 300) return { text: "Very Unhealthy", colorClass: "very-unhealthy" };
            return { text: "Hazardous", colorClass: "hazardous" };
        }

        function getAQIColor(aqi) {
            const status = getAQIStatus(aqi);
            const colorMap = {
                'good': 'green', 'moderate': 'orange', 'unhealthy-sensitive': 'orange',
                'unhealthy': 'red', 'very-unhealthy': 'purple', 'hazardous': '#7e0023'
            };
            const colorName = colorMap[status.colorClass] || 'red';
            return colorName.startsWith('#') ? colorName : getComputedStyle(document.documentElement).getPropertyValue(`--primary-${colorName}`);
        }

        // --- DATA FETCHING AND INITIALIZATION ---
        async function initializeDashboard() {
            try {
                const response = await fetch('http://localhost:3000/api/dashboard');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                zonesData = data.zones;

                zoneSelect.innerHTML = zonesData.map(z => `<option value="${z.name}">${z.name}</option>`).join('');

                const overallAQI = data.overallAQI;
                const overallStatus = getAQIStatus(overallAQI);
                overallAQIElement.textContent = overallAQI;
                overallAQIElement.className = `aqi-value text-color-${overallStatus.colorClass}`;
                overallStatusElement.textContent = `${overallStatus.text} air quality`;
                overallStatusElement.className = `aqi-status status-color-${overallStatus.colorClass}`;

                updateMapMarkers(zonesData);

                if (zonesData.length > 0) {
                    updateZonePanel(zonesData[0]);
                }

                document.getElementById('last-updated').textContent = new Date(data.lastUpdated).toLocaleTimeString('en-IN', {
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                recentAlertText.innerHTML = `<strong>Alert:</strong> ${data.recentAlert}`;

            } catch (error) {
                console.error('Failed to fetch dashboard data:', error);
                overallAQIElement.textContent = 'Error';
                overallStatusElement.textContent = 'Could not load data.';
            }
        }

        function updateMapMarkers(zones) {
            for (const markerName in markers) {
                map.removeLayer(markers[markerName]);
                delete markers[markerName];
            }

            zones.forEach(zone => {
                const marker = L.circleMarker(zone.coords, {
                    radius: 10, fillColor: getAQIColor(zone.aqi), color: getAQIColor(zone.aqi),
                    weight: 2, opacity: 1, fillOpacity: 0.8
                }).addTo(map);

                const status = getAQIStatus(zone.aqi);
                marker.bindPopup(`<strong>${zone.name}</strong><br>AQI: ${zone.aqi} (${status.text})`);
                marker.on('click', () => {
                    zoneSelect.value = zone.name;
                    updateZonePanel(zone);
                });
                markers[zone.name] = marker;
            });
        }
        
        // --- INTERACTIVITY ---
        function updateZonePanel(zone) {
            if (!zone) return;
            const status = getAQIStatus(zone.aqi);

            zoneNameDisplay.textContent = zone.name;
            zoneAQIValueElement.textContent = zone.aqi;
            zoneAQIValueElement.className = `zone-aqi-value text-color-${status.colorClass}`;
            zoneAQIStatusElement.textContent = `${status.text} air quality`;
            zoneAQIStatusElement.className = `zone-aqi-status-small status-color-${status.colorClass}`;

            pm25Value.textContent = zone.pollutants.pm25 ?? 'N/A';
            co2Value.textContent = zone.pollutants.co2 ?? 'N/A';
            no2Value.textContent = zone.pollutants.no2 ?? 'N/A';

            map.setView(zone.coords, 13, { animate: true, duration: 0.5 });
            if (markers[zone.name]) {
                markers[zone.name].openPopup();
            }
        }

        zoneSelect.addEventListener('change', (e) => {
            const selectedZone = zonesData.find(z => z.name === e.target.value);
            if (selectedZone) {
                updateZonePanel(selectedZone);
            }
        });

        // --- LEGEND ---
        const legend = L.control({ position: "bottomright" });
        legend.onAdd = function (map) {
            const div = L.DomUtil.create("div", "info legend");
            const levels = [50, 100, 150, 200, 300, 500];
            let html = "<h4>AQI Levels</h4>";
            levels.forEach((limit, index) => {
                const aqiMin = index === 0 ? 0 : levels[index - 1] + 1;
                const status = getAQIStatus(limit);
                html += `
                <i style="background:${getAQIColor(limit)}; width:12px; height:12px; border-radius: 50%; display:inline-block; margin-right:6px;"></i>
                ${status.text} (${aqiMin} - ${limit === 500 ? '500+' : limit})<br>
            `;
            });
            div.innerHTML = html;
            div.style.background = "white";
            div.style.padding = "10px";
            div.style.borderRadius = "8px";
            div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
            return div;
        };
        legend.addTo(map);

        // --- KICK IT OFF ---
        initializeDashboard();
    </script>
</body>
</html>